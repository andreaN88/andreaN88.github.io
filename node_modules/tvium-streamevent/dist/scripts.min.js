var StreamEvent=function(){var e=null,d={AdEvent:"ADEVENT",BinaryEvent:"BINARY_EVENT"},_=this,t={};function a(e){objVideo?2===objVideo.playState?(logManager.log("presenting channel ready"),e()):(logManager.log("presenting channel not ready, listen playstateChange"),objVideo.onPlayStateChange=n):logManager.warning("The application is broadcast dependent, try to attach to broadcast")}function n(e,t){switch(e){case 0:logManager.log("state video broadcast: unrealized");break;case 1:logManager.log("state video broadcast: connecting");break;case 2:logManager.log("state video broadcast: presenting"),_.initStreamEventsMethod(),objVideo.onPlayStateChange=function(){};break;case 3:logManager.log("state video broadcast: stopped")}}function r(){try{null!=(e=function(){var e=null;{if(featuresManager.getFeature("streamEventDVBMethod")){var t=null,a=null;try{var n=objVideo.currentChannel;n?(t=n.onid.toString(16)+"."+n.tsid.toString(16)+"."+n.sid.toString(16),logManager.log("current channel ID(hex) = "+t+", type=null, name="+n.name)):logManager.warning("currentChannel not defined")}catch(e){throw logManager.error("getUrlStreamEventObj: "+e),e}return serviceManager.getCurrentChannel()&&(e=serviceManager.getCurrentChannel().getChannelToString(),null==_.getConfiguration().STREAM_EVENT_CONFIGURATION[e]?logManager.warning("getUrlStreamEventObj - No DVB STREAM EVENT CONFIGURATION for this channel ("+e+")"):a="dvb://"+t+"."+_.getConfiguration().STREAM_EVENT_CONFIGURATION[e].DVB_OBJECT_CAROUSEL_COMPONENT_TAG.toString(16)+"/"+_.getConfiguration().STREAM_EVENT_CONFIGURATION[e].DVB_STREAM_EVENTS_OBJECT_NAME),a}if(featuresManager.getFeature("streamEventXMLMethod"))return serviceManager.getCurrentChannel()&&(e=serviceManager.getCurrentChannel().getChannelToString()),logManager.log(_.getConfiguration().STREAM_EVENT_CONFIGURATION[e].XML_STREAM_EVENTS_XML_DEFINITION),_.getConfiguration().STREAM_EVENT_CONFIGURATION[e].XML_STREAM_EVENTS_XML_DEFINITION}}())?(logManager.log("streamEventObjectURL: "+e),objVideo.addStreamEventListener(e,"ADEVENT",i),logManager.log("ADEVENT Registered"),objVideo.addStreamEventListener(e,"BINARY_EVENT",p),logManager.log("BINARY_EVENT Registered")):logManager.warning("registerEvents: Stream Events Listeners not registered, no Carousel definition for this channel")}catch(e){logManager.error("registerEvents: "+e)}}function c(){logManager.log("Stream event Unregistering...");try{objVideo.removeStreamEventListener(e,"ADEVENT",i),logManager.log("ADEVENT Unregistered"),objVideo.removeStreamEventListener(e,"BINARY_EVENT",p),logManager.log("BINARY_EVENT Unregistered")}catch(e){logManager.error("Error on Stream event Unregistered: "+e.message)}logManager.log("Stream event Unregistered")}function p(e,t){try{if(e&&e.name===d.BinaryEvent){if(logManager.log("onBinaryEventReceived: "+h(e)),"error"===e.status)logManager.warning("Event onBinaryEventReceived on error status, re-registering Stream Events listeners."),c(),_.initStreamEventsMethod();else if("trigger"===e.status){logManager.log("BINARY_EVENT received");var a=new SCTE35Parser;t&&logManager.log("retrying..."),logManager.log("parsing with BASE64");var n=a.parseFromBase64(e.text);logManager.log(JSON.stringify(n));var r=n.descriptors,i={};if(r&&0<r.length){for(var o=0;o<r.length;o++)if(logManager.log(r[o].segmentation_type_id),_.getConfiguration().TRIGGERABLE_FN_ON_SCTE35_MAP&&_.getConfiguration().TRIGGERABLE_FN_ON_SCTE35_MAP[r[o].segmentation_type_id]&&_.getConfiguration().TRIGGERABLE_FN_ON_SCTE35_MAP[r[o].segmentation_type_id].FN){logManager.log("triggerable function by "+r[o].segmentation_type_id+" found");var s={},g=_.getConfiguration().TRIGGERABLE_FN_ON_SCTE35_MAP[r[o].segmentation_type_id].ATTRIBUTES;if(g&&0<g.length)for(var l=0;l<g.length;l++)s[g[l]]=r[o][g[l]];i[r[o].segmentation_type_id]=_.getConfiguration().TRIGGERABLE_FN_ON_SCTE35_MAP[r[o].segmentation_type_id].FN(s,n)}}else t||p(e,!0)}}else e?logManager.warning("onBinaryEventReceived - wrong event Name: "+e.name):logManager.warning("onBinaryEventReceived - payload not defined")}catch(e){logManager.error("onBinaryEventReceived - error: "+e.message)}}function i(e){try{e&&e.name===d.AdEvent?(logManager.log("onAdEventReceived: "+h(e)),"error"===e.status?(logManager.warning("Event onAdEventReceived on error status, re-registering Stream Events listeners."),c(),_.initStreamEventsMethod()):"trigger"===e.status&&(e.text?JSON.parse(e.text).hasOwnProperty("event_type")?logManager.error("onAdEventReceived - Stream Event ignored."):_.getConfiguration().TRIGGERABLE_FN_ON_EVENT&&_.getConfiguration().TRIGGERABLE_FN_ON_EVENT(e):logManager.error("onAdEventReceived - empty payload!"))):e?logManager.warning("onAdEventReceived - wrong event Name: "+e.name):logManager.warning("onAdEventReceived - payload not defined")}catch(e){logManager.error("onAdEventReceived - error: "+e.message)}}function h(e){var t="";try{var a=JSON.stringify(e,null,4),t="{}"===a?"Status:"+e.status+" - Text: "+e.text:a}catch(e){}return t}this.configure=function(e){t=e},this.getConfiguration=function(){return t},this.initStreamEventsMethod=function(){logManager.log("Stream Events Listening Method init..."),objVideo=serviceManager.getObjVideo();try{featuresManager.getFeature("streamEventDVBMethod")?(logManager.log("Adv Listening Method: streamEventDVBMethod"),a(r)):featuresManager.getFeature("streamEventXMLMethod")?(logManager.log("Adv Listening Method: streamEventXMLMethod"),a(r)):logManager.log("Adv Listening Method: none (as per features file definition)")}catch(e){logManager.error("initStreamEventsMethod: "+e)}}};function SCTE35Parser(){this.init=function(){this.scte35_bitarray=new Array,this.spliceInfo={}},this.parseFromBase64=function(e){this.init();for(var t=window.atob(e),a=t.length,n=new Uint8Array(new ArrayBuffer(a)),r=0;r<a;r++)n[r]=t.charCodeAt(r),this.writeToBitArray(n[r]);return this.parse(),this.spliceInfo},this.parseFromHex=function(e){if(this.init(),!e||e.length<0)return"no data";for(var t=0;t<e.length;t+=2){parseInt("0x"+e[t]+e[t+1]);this.writeToBitArray(parseInt(e[t]+e[t+1],16))}return this.parse(),this.spliceInfo},this.parse=function(){var e=this.read(8);if(252==e){var t=this.spliceInfo;t.segmentation_type_id_list=[],t.table_id=e,t.section_syntax_indicator=this.read(1),t.private_indicator=this.read(1),this.read(2),t.section_length=this.read(12),t.protocol_version=this.read(8),t.encrypted_packet=this.read(1),t.encryption_algorithm=this.read(6),t.pts_adjustment=this.read(33),t.cw_index=this.read(8),t.tier=this.read(12),t.splice_command_length=this.read(12),t.splice_command_type=this.read(8),0==t.splice_command_type?this.parse_splice_null():4==t.splice_command_type?this.parse_splice_schedule():5==t.splice_command_type?(t.splice_command_type_text="splice_insert",this.parse_splice_insert()):6==t.splice_command_type?(t.splice_command_type_text="time_signal",this.parse_time_signal()):7==t.splice_command_type?this.bandwidth_reservation():6==t.splice_command_type&&this.parse_private_command(),t.descriptor_loop_length=this.read(16),t.descriptors=[];for(var a=this.scte35_bitarray.length,n=0;n<t.descriptor_loop_length&&!(a-this.scte35_bitarray.length>=8*t.descriptor_loop_length);n++){var r={};if(r.splice_descriptor_tag=this.read(8),r.descriptor_length=this.read(8),r.identifier=this.read(32),1129661769==r.identifier){switch(r.splice_descriptor_tag){case 0:case 1:break;case 2:if(r.segmentation_event_id=this.read(32),r.segmentation_event_cancel_indicator=this.read(1),r.reserved=this.read(7),"0"==r.segmentation_event_cancel_indicator&&(r.program_segmentation_flag=this.read(1),r.segmentation_duration_flag=this.read(1),r.delivery_not_restricted_flag=this.read(1),"0"==r.delivery_not_restricted_flag?(r.web_delivery_allowed_flag=this.read(1),r.no_regional_blackout_flag=this.read(1),r.archive_allowed_flag=this.read(1),r.device_restrictions=this.read(2)):r.reserved=this.read(5),"0"==r.program_segmentation_flag)){r.component_count=this.read(8),r.components=[];for(var i=0;i<r.component_count;i++){var o={};o.component_tag=this.read(8),o.reserved=this.read(7),o.pts_offset=this.read(33),r.components.push(o)}}switch("1"==r.segmentation_duration_flag&&(r.segmentation_duration=this.read(40)),r.segmentation_upid_type=this.read(8),r.segmentation_upid_length=this.read(8),this.parse_segmentation_upid(r),r.segmentation_type_id=this.read(8),t.segmentation_type_id_list.push(r.segmentation_type_id),r.segmentation_type_id){case 0:logManager.log("Type = Not Indicated\n");break;case 1:logManager.log("Type = Content Identification\n");break;case 16:logManager.log("Type = Program Start\n");break;case 17:logManager.log("Type = Program End\n");break;case 18:logManager.log("Type = Program Early Termination\n");break;case 19:logManager.log("Type = Program Breakaway\n");break;case 20:logManager.log("Type = Program Resumption\n");break;case 21:logManager.log("Type = Program Runover Planned\n");break;case 22:logManager.log("Type = Program Runover Unplanned\n");break;case 23:logManager.log("Type = Program Overlap Start\n");break;case 32:logManager.log("Type = Chapter Start\n");break;case 33:logManager.log("Type = Chapter End\n");break;case 48:logManager.log("Type = Provider Advertisement Start\n");break;case 49:logManager.log("Type = Provider Advertisement End\n");break;case 50:logManager.log("Type = Distributor Advertisement Start\n");break;case 51:logManager.log("Type = Distributor Advertisement End\n");break;case 52:logManager.log("Type = Placement Opportunity Start\n");break;case 53:logManager.log("Type = Placement Opportunity End\n");break;case 64:logManager.log("Type = Unscheduled Event Start\n");break;case 65:logManager.log("Type = Unscheduled Event End\n");break;case 80:logManager.log("Type = Network Start\n");break;case 81:logManager.log("Type = Network End\n");break;default:logManager.log("Type = Unknown = "+r.segmentation_type_id+"\n")}r.segment_num=this.read(8),r.segments_expected=this.read(8)}t.descriptors.push(r)}else this.read(8*r.descriptor_length-32)}}},this.parse_splice_null=function(){throw"command_type splice_null not supported yet"},this.parse_splice_schedule=function(){throw"command_type splice_schedule not supported yet"},this.parse_splice_insert=function(){var e={};(this.spliceInfo.splice_event=e).splice_event_id=this.read(32),e.splice_event_cancel_indicator=this.read(1),this.read(7),0==e.splice_event_cancel_indicator&&(e.out_of_network_indicator=this.read(1),e.program_splice_flag=this.read(1),e.duration_flag=this.read(1),e.splice_immediate_flag=this.read(1),this.read(4),1==e.program_splice_flag&&0==e.splice_immediate_flag&&this.parse_splice_time(this.spliceInfo.splice_event),1==e.duration_flag&&this.parse_break_duration(),e.unique_program_id=this.read(16),e.avail_num=this.read(8),e.avails_expected=this.read(8))},this.parse_time_signal=function(){var e={};this.spliceInfo.splice_event=e,this.parse_splice_time(e)},this.parse_bandwidth_reservation=function(){throw"command_type bandwidth_reservation not supported yet"},this.parse_private_command=function(){throw"command_type private_command not supported yet"},this.parse_splice_time=function(e){e.time_specified_flag=this.read(1),1==e.time_specified_flag?(this.read(6),e.pts_time=this.read(33)):this.read(7)},this.parse_break_duration=function(){var e={};(this.spliceInfo.splice_event.break_duration=e).auto_return=this.read(1),e.reserved=this.read(6),e.duration=this.read(33)},this.parse_segmentation_upid=function(e){switch(e.segmentation_upid_type){case 0:case 8:break;case 12:e.identifier_format=this.read(32),e.segmentation_upid=this.read(8*e.segmentation_upid_length-32);break;case 15:e.segmentation_upid_length;for(var t="",a=0;a<e.segmentation_upid_length;a++){var n=this.read(8);t+=String.fromCharCode(n)}e.segmentation_upid=t}},this.writeToBitArray=function(e){for(var t=128,a=0;a<8;a++)this.scte35_bitarray[this.scte35_bitarray.length]=t&e?!0:!1,t>>=1},this.read=function(e){var t=this.scte35_bitarray.splice(0,e),a=0;if(32<e){for(var n=0;n<e-32;n++)a<<=1,t.shift()&&(a+=1);a*=Math.pow(2,32),e=32}for(var r=0,n=0;n<e;n++)r<<=1,t.shift()&&(r+=1);return 32<=e&&(r>>>=0),a+r},this.test=function(e){e=e||"fc302000000000000000fff00f05000000007fcfffa7f7abd400680001000088f3ebaf",logManager.log("testString = "+e);e=this.parseFromHex(e);logManager.log(this.scte35_array),logManager.log(JSON.stringify(e))}}