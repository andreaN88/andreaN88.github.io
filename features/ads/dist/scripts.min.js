var Adv=function(){var r,m=this,p=new AdvHashmap,S=new AdvRequests,A={};this.ptsHandlerComponent=new PtsHandlerComponent,this.callAdServerRoundTripTime=0;var v={};function f(e){try{var t=JSON.parse(e);if(t.STARTdata.triplet!==serviceManager.getCurrentChannel().getChannelToString())return void logManager.warning("startEventProcess - event triplet ("+t.STARTdata.triplet+") not corresponding to current channel's triplet ("+serviceManager.getCurrentChannel().getChannelToString()+")");p.getValue(t.STARTdata.break_code)?n(e):v.CALL_ADSERVER_FALLBACK_ON_STARTEVENT&&"spot"===v.AD_SUBSTITUTION_METHOD?(logManager.log("startEventProcess - break_code not found in dictionary: triggering callAdServer."),a(e,function(){n(e)})):logManager.warning("startEventProcess - break code not found in dictionary.")}catch(e){logManager.error("startEventProcess - error: "+e.message)}}function a(e,r){try{if(null==featuresManager.getFeature("linearAdTracking")||!0!==featuresManager.getFeature("linearAdTracking"))return void logManager.warning("callAdServerProcess - linearAdTracking feature is not true");if(consent&&(null==consent.getModel()||!0!==consent.getModelConsents().TRACKING.consentStatus))return void logManager.warning("callAdServerProcess - user consent not given to TRACKING");var i=JSON.parse(e);if(0!==Object.keys(A).length&&"break"===v.AD_SUBSTITUTION_METHOD)return void logManager.warning("callAdServerProcess - Discarding Event: Break tracking already in progress.");if(i.LOADdata.triplet!==serviceManager.getCurrentChannel().getChannelToString())return void logManager.warning("callAdServerProcess - event triplet ("+i.LOADdata.triplet+") not corresponding to current channel's triplet ("+serviceManager.getCurrentChannel().getChannelToString()+")");if(p.isAdvIDExists(i.LOADdata.break_code))return void logManager.warning("callAdServerProcess - break code already loaded");if(p.initialize(i.LOADdata.break_code),p.setStatus(i.LOADdata.break_code,p.lstStatus.LOADING),consent&&null==consent.getModel())return void logManager.warning("callAdServerProcess - getWizadsData() the tvId is not retrived yet");i.LOADdata.channel&&(i.LOADdata.channel=i.LOADdata.channel.toUpperCase());var t=consent?consent.getModel().tvId:"",a=t+(new Date).getTime(),n=i.LOADdata.dai_version,o=i.LOADdata.channel,s=i.LOADdata.break_code,g=i.LOADdata.bday||"",l=i.LOADdata.break_duration,c=core.getPlatform().brand.toLowerCase().trim(),d=v.AD_SUBSTITUTION_METHOD,u=v.ADSERVER_URL;u+="?dai_version="+n+"&transaction_id="+a+"&response_type="+d+"&channel="+o+"&break_code="+s+"&break_day="+g+"&break_duration="+l+"&advertising_id="+t+"&platform="+c+"&context=live&current_spot=0";var T=Date.now();S.getWizadsData(u,function(e){var t,a;function n(){logManager.log("breakTracking - Processing break["+t.LOADdata.break_code+"] - Sequence["+a+"] started");var e={LOADdata:t.LOADdata,STARTdata:{break_code:t.STARTdata.break_code,sequence:a,triplet:t.STARTdata.triplet,duration:A.spots[a].duration,pts:0}};null!=A.spots[a+1]&&window.setTimeout(n,A.spots[a].duration+v.BLACK_FRAMES_DURATION_AFTER_SPOT),f(JSON.stringify(e)),a++}m.callAdServerRoundTripTime=Date.now()-T,0!==Object.keys(e).length?(function(e,t){try{A={},logManager.log("createDictionary() - Creating dictionary");var a=t.Ads;if(0<a.length){A.id=e,logManager.log("createDictionary() - dictionary.id: "+A.id),A.spots=[];for(var n=0;n<a.length;n++)A.spots[parseInt(a[n].Sequence)]=function(e){var t;return(t=function(e){try{var t={},a=e.InLine.Creatives[0].Linear.Duration;t.duration=1e3*+a,t.tracking={};var n=e.InLine.Creatives[0].Linear.TrackingEvents;t.tracking.impression=e.InLine.Impressions[0].Data.trim();for(var r=0;r<n.length;r++)switch(n[r].Event){case"firstQuartile":t.tracking.firstQuartile=n[r].Data.trim();break;case"midpoint":t.tracking.midpoint=n[r].Data.trim();break;case"thirdQuartile":t.tracking.thirdQuartile=n[r].Data.trim();break;case"complete":t.tracking.complete=n[r].Data.trim()}var i=e.InLine.Creatives[0].Linear.MediaFiles[0].Data.trim();return t.media_file_url=i,t.media_file_type="addressed",-1!==i.indexOf("broadcasted")&&(t.media_file_type="broadcasted"),t}catch(e){logManager.error("createTrackingItemsForDictionary: "+e)}}(e)).companionAd=function(e){try{var t={};return t=null!=e.InLine.Creatives[0].CompanionAds?e.InLine.Creatives[0].CompanionAds:t}catch(e){logManager.error("createCompanionAdForDictionary: "+e)}}(e),t}(a[n]),logManager.log("createDictionary() - dictionary.spots["+parseInt(a[n].Sequence)+"] tracking items loaded")}else logManager.log("createDictionary() - no Ads found in VAST file.")}catch(e){logManager.error("createDictionary: "+e)}}(i.LOADdata.break_code,e),p.setValue(i.LOADdata.break_code,A,p.type.STREAMEVENT),p.setStatus(i.LOADdata.break_code,p.lstStatus.LOADED),null!=r&&r(),"break"===v.AD_SUBSTITUTION_METHOD&&(a=(t=i).STARTdata.sequence,featuresManager.getFeature("PTSMethod")?(logManager.warning("breakTracking - Waiting first START PTS time in order to start tracking queue."),m.ptsHandlerComponent.ptsStartEventTimeCheck(t.STARTdata.pts,t,n)):(logManager.warning("breakTracking - no PTS or Delay method for this client in the feature file. Queuing starts immediately."),n()))):logManager.log("callAdServerProcess - VAST file is an empty object.")},function(e){M(i.LOADdata.break_code),logManager.error("getWizadsData() KO Response")})}catch(e){logManager.error("callAdServerProcess - error: "+e.message)}}function n(e){var t=JSON.parse(e),a=p.getValue(t.STARTdata.break_code);if(a.status===p.lstStatus.LOADED||a.status===p.lstStatus.STARTED)if(p.setStatus(t.STARTdata.break_code,p.lstStatus.STARTED),A.spots.hasOwnProperty(t.STARTdata.sequence))if(logManager.log("startEventProcessPostValidation - Event payload: "+e),t.STARTdata.duration===A.spots[t.STARTdata.sequence].duration)switch(v.AD_SUBSTITUTION_METHOD){case"spot":featuresManager.getFeature("PTSMethod")?m.ptsHandlerComponent.ptsStartEventTimeCheck(t.STARTdata.pts,t,i):logManager.warning("startEventProcess - no PTS or Delay method for this client in the feature file.");break;case"break":i(t);break;default:logManager.warning('startEventProcess - no "break" or "spot" mode enabled.')}else logManager.warning("startEventProcess - spot duration in Stream Event payload ("+t.STARTdata.duration+") not matching the VAST duration for this spot ("+A.spots[t.STARTdata.sequence].duration+")");else logManager.warning("startEventProcess - sequence not found: "+t.STARTdata.sequence);else logManager.warning("startEventProcess - incorrect status : "+a.status)}function i(e){p.getValue(e.STARTdata.break_code)?!consent||null!=consent.getModel()&&!0===consent.getModelConsents().TRACKING.consentStatus?featuresManager.getFeature("linearAdTracking")&&!0===featuresManager.getFeature("linearAdTracking")&&o(e.STARTdata.sequence,e.STARTdata.break_code):(logManager.warning("startEventCoreProcess - user consent not given to TRACKING"),g(e.STARTdata.break_code,e.STARTdata.sequence)):logManager.warning("startEventCoreProcess - break code not found")}function o(t,a){try{var e,n;null!=A&&0<Object.keys(A).length&&null!=t&&A.id===a?(e=A.spots[t].duration/4,n=0,s(A.spots[t].tracking.impression,"impression",t),r=window.setInterval(function(){switch(++n){case 1:s(A.spots[t].tracking.firstQuartile,"firstQuartile",t);break;case 2:s(A.spots[t].tracking.midpoint,"midpoint",t);break;case 3:s(A.spots[t].tracking.thirdQuartile,"thirdQuartile",t);break;case 4:!function(e,t){s(A.spots[e].tracking.complete,"complete",e),r&&window.clearInterval(r);g(t,e),logManager.log("Adv pixel tracking schedulation ended.")}(t,a)}},e)):logManager.warning("scheduleSpotTracking - empty dictionary")}catch(e){logManager.error("scheduleSpotTracking: "+e),g(a,t)}}function s(e,t,a){if(trace&&trace.injectTrackingPixel(e),v.VISIBLE_AD_TRACKING)switch(t){case"impression":case"complete":!function(e,t,a){var n=$(".trackingPopupContainer"),r="5%";1<=n.length&&(r="50%");var i=$("<div class='trackingPopupContainer' style='position:absolute; top:"+r+"; left:65px; width: 50%; padding:5px; z-index: 9999; background-color:rgba(255,255,255,0.7); color:#000; border:1px solid #000; word-break: break-all;'><b>Sequence: </b>"+a+"<br /><b>Tracking: </b>"+$.camelCase(e)+"<br /><b>URL: </b> "+escapeXml(t)+"</div>");$(".tvium-container").append(i),window.setTimeout(function(){i.remove()},3e3)}(t,e,a)}logManager.log("Sequence["+a+"] - "+t+" pixel image loaded - "+escapeXml(e))}function g(e,t){A.spots.hasOwnProperty(t)?(delete A.spots[t],0===Object.keys(A.spots).length&&(M(e),p.clearLst(),A={},logManager.log("All spots of the break has been removed!"))):logManager.warning("removeSpotFromDictionary - "+t+" not found")}function M(e){p.isAdvIDExists(e)?(p.setStatus(e,p.lstStatus.STOP),p.deleteAdv(e)):logManager.warning("clearAdv - event ID not found")}return{configure:function(e){v=e},getConfiguration:function(){return v},onFiredAdv:function(e){"spot"===v.AD_SUBSTITUTION_METHOD?f(e.text):"break"===v.AD_SUBSTITUTION_METHOD?a(e.text,null):logManager.warning("onAdEventReceived - No SpotMode or BreakMode set in the configuration.")},callAdServerProcess:a,callVastAdServerProcess:function(e,t,a){p.isAdvIDExists(t.segmentation_upid)?logManager.warning("callAdServerProcess - break code already loaded"):(p.initialize(t.segmentation_upid),p.setStatus(t.segmentation_upid,p.lstStatus.LOADING),S.doFreewheelAdCall(e,t,a,function(e){e&&0===e.getElementsByTagNameNS("http://www.iab.net/vmap-1.0","VMAP").length?logManager.log("onFiredSCTEAdv - VAST file is an empty object."):(function(e,t){try{A={},logManager.log("createDictionaryVAST() - Creating dictionary");var a=t.getElementsByTagNameNS("http://www.iab.net/vmap-1.0","VMAP")[0].getElementsByTagNameNS("http://www.iab.net/vmap-1.0","AdBreak");if(0==a.length)logManager.log("createDictionaryVAST() - no Ad Break found in VAST file.");else try{var n=a[0].getElementsByTagNameNS("http://www.iab.net/vmap-1.0","AdSource")[0].getElementsByTagNameNS("http://www.iab.net/vmap-1.0","VASTAdData")[0].getElementsByTagName("VAST")[0].getElementsByTagName("Ad")}catch(e){logManager.log("createDictionaryVAST() - error on VAST parsing. "+e)}if(0<n.length){A.id=e,logManager.log("createDictionaryVAST() - dictionary.id: "+A.id),A.spots=[];for(var r=0;r<n.length;r++)A.spots[parseInt(n[r].getAttribute("sequence"))]=function(e){try{var t={},a=e.getElementsByTagName("InLine")[0].getElementsByTagName("Creatives")[0].getElementsByTagName("Creative")[0].getElementsByTagName("Linear")[0].getElementsByTagName("Duration")[0].textContent.split(":");t.duration=60*+a[0]*60+60*+a[1]+1e3*+a[2],t.tracking={};var n=e.getElementsByTagName("InLine")[0].getElementsByTagName("Creatives")[0].getElementsByTagName("Creative")[0].getElementsByTagName("Linear")[0].getElementsByTagName("TrackingEvents")[0].getElementsByTagName("Tracking");t.tracking.impression=e.getElementsByTagName("InLine")[0].getElementsByTagName("Impression")[0].textContent.trim();for(var r=0;r<n.length;r++)switch(n[r].getAttribute("event")){case"firstQuartile":t.tracking.firstQuartile=n[r].textContent.trim();break;case"midpoint":t.tracking.midpoint=n[r].textContent.trim();break;case"thirdQuartile":t.tracking.thirdQuartile=n[r].textContent.trim();break;case"complete":t.tracking.complete=n[r].textContent.trim()}var i=e.getElementsByTagName("InLine")[0].getElementsByTagName("Creatives")[0].getElementsByTagName("Creative")[0].getElementsByTagName("Linear")[0].getElementsByTagName("MediaFiles")[0].getElementsByTagName("MediaFile")[0].textContent.trim();return t.media_file_url=i,t.media_file_type="addressed",-1===i.indexOf(".mp4")&&-1===i.indexOf(".mpd")||(t.media_file_type="broadcasted"),t}catch(e){logManager.error("createTrackingItemsForDictionary: "+e)}}(n[r]),logManager.log("createDictionaryVAST() - dictionary.spots["+parseInt(n[r].getAttribute("sequence"))+"] tracking items loaded")}else logManager.log("createDictionaryVAST() - no Ads found in VAST file.")}catch(e){logManager.error("createDictionaryVAST: "+e)}}(t.segmentation_upid,e),p.setValue(t.segmentation_upid,A,p.type.STREAMEVENT),p.setStatus(t.segmentation_upid,p.lstStatus.LOADED))},function(e){M(t.segmentation_upid),logManager.error("doFreewheelAdCall() KO Response")}))},startProcess:f,startSCTEProcess:function(n,r){function e(e){var t,a;10<e&&window.clearInterval(i),(a=p.getLoadedAdv())?(e=p.getValue(a)).status===p.lstStatus.LOADED||e.status===p.lstStatus.STARTED?(p.setStatus(a,p.lstStatus.STARTED),n.segmentation_upid=a,t=n,a=r,m.ptsHandlerComponent.ptsStartEventTimeCheck(a.splice_event.pts_time,null,function(){featuresManager.getFeature("linearAdTracking")&&!0===featuresManager.getFeature("linearAdTracking")&&o(t.segment_num,t.segmentation_upid)}),window.clearInterval(i)):logManager.warning("startSCTEProcess - incorrect status : "+e.status):logManager.warning("startSCTEProcess - no dictionary loaded with "+n.segmentation_upid)}var t,i=null;r.segmentation_type_id_list&&-1<r.segmentation_type_id_list.indexOf(2)?(t=0,i=setInterval(function(){e(t++)},1e3)):e()}}},AdvHashmap=function(){var n={status:null,dictionary:null},a=null,r={LOADING:"LOADING",LOADED:"LOADED",STARTING:"STARTING",STARTED:"STARTED",STOP:"STOP"};function i(e){return e in n}return{deleteAdv:function(e){delete n[e],logManager.log("deleteAdv -  Adv Deleted!")},initialize:function(e){n[e.toString()]={status:null,dictionary:null}},setValue:function(e,t,a){i(e)||(n[e]={}),n[e].dictionary=t,n[e].type=a},getValue:function(e){return i(e)?n[e]:null},setStatus:function(e,t){i(e)?(n[e].status=t)==r.LOADED?a=e:t==r.STOP&&(a=null,logManager.log("Status: "+t)):logManager.warning("Adv ID not found: "+e)},isAdvIDExists:i,isAdvAlreadyLoaded:function(){return null!=a},lstStatus:r,type:{STREAMEVENT:"STREAMEVENT"},clearLst:function(){n={},a=null},lstAdvIsEmpty:function(){return 0==Object.keys(n).length||0==Object.keys(n).length},getLoadedAdv:function(){return a}}},PtsHandlerComponent=function(){this.ptsStartEventTimeCheck=function(a,n,r){null!=mediaSyncManager.getCurrentTime()?(logManager.log("ptsStartEventTimeCheck - currentTime: "+mediaSyncManager.getCurrentTime()+" - PTS check starting in "+(a-mediaSyncManager.getCurrentTime()-adv.getConfiguration().PTS_CHECK_START_TIME-featuresManager.getFeature("ptsSpotModeSwitchInDurationFineTuning"))+"Ms."),setTimeout(function(){var t=setInterval(function(){var e=mediaSyncManager.getCurrentTime();logManager.log("MediaSynchroniser.currentTime = "+e+" - Event PTS time = "+a+" - Time difference = "+(Math.abs(a-e)-featuresManager.getFeature("ptsSpotModeSwitchInDurationFineTuning"))),a-e-featuresManager.getFeature("ptsSpotModeSwitchInDurationFineTuning")+adv.getConfiguration().PTS_CHECK_TOLERANCE<0&&(logManager.warning("ptsStartEventTimeCheck - payload PTS already expired. We can't go back in time Morty!"),window.clearInterval(t)),Math.abs(a-e-featuresManager.getFeature("ptsSpotModeSwitchInDurationFineTuning"))<=adv.getConfiguration().PTS_CHECK_TOLERANCE&&(r(n),window.clearInterval(t))},adv.getConfiguration().PTS_CHECK_INTERVAL_TIME+featuresManager.getFeature("PTSCheckIntervalFineTuning"))},a-mediaSyncManager.getCurrentTime()-adv.getConfiguration().PTS_CHECK_START_TIME-featuresManager.getFeature("ptsSpotModeSwitchInDurationFineTuning"))):logManager.error("ptsStartEventTimeCheck - MediaSynchroniser not available")}},AdvRequests=function(){var s=0;this.getWizadsData=function(n,r,i){var o="AdvRequests.getWizadsData()",e=n;logManager.log(o+" CALLED - url: "+n),$.ajax({type:"GET",contentType:"application/json",dataType:"json",url:e,timeout:adv.getConfiguration().GET_WIZADS_TIMEOUT,success:function(e,t,a){logManager.log(o+" - Response : OK"),r(e)},error:function(e,t,a){logManager.error(o+" - Error : "+JSON.stringify(a,null,4)),"timeout"===t&&s<1&&(s++,self.getWizadsData(n,r,i)),i()}})},this.doFreewheelAdCall=function(e,t,a,n,r){null==t.segmentation_duration&&(t.segmentation_duration="");var i="AdvRequests.doFreewheelAdCall()",t="https://7e28b.v.fwmrm.net/ad/g/1?nw=516747&mode=live&prof=516747:alpha_JL_XML&caid=jl_videoasset1&csid=alpha_jl_sitesection_iptv_1&resp=vmap1&metr=7&vrdu="+t.segmentation_duration+"&flag=+emcr+qtcb+slcb+scpv+exvt;_fw_hylda=acid="+e.acid+"%26aiid="+t.segmentation_upid+"%26abid%3Dbreak://14102021_1340&_fw_vcid2=12345&tvium=yes;slid="+t.segmentation_upid+"&tpcl=MIDROLL&ptgt=a&maxd="+t.segmentation_duration+"&mind="+t.segmentation_duration;logManager.log(i+" CALLED - url: "+t),$.ajax({type:"GET",dataType:"xml",url:t,success:function(e,t,a){logManager.log(i+" - Response : OK"),n(e)},error:function(e,t,a){logManager.error(i+" - Error : "+JSON.stringify(a,null,4)),r()}})}};